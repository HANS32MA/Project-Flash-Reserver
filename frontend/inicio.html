<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flash Reserver</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/inicio.css">
    <link rel="icon" href="/assets/img/logo.png" type="image/png">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h4>Flash Reservas</h4>
        </div>
        
        <div class="user-profile">
            <img src="/assets/img/logo.png" alt="Foto de perfil">
            <h5>¡Hola, Bienvenidos!</h5>
        </div>
        
        <ul class="sidebar-menu">
            <li><a href="#perfil" class="active" data-page="perfil"><i class="fas fa-user"></i> Mi Perfil</a></li>
            <li><a href="#canchas" data-page="canchas"><i class="fas fa-futbol"></i> Canchas</a></li>
            <li><a href="#reservas" data-page="reservas"><i class="fas fa-calendar-plus"></i> Nueva Reserva</a></li>
            <li><a href="#mis-reservas" data-page="mis-reservas"><i class="fas fa-calendar-check"></i> Mis Reservas</a></li>
            <li><a href="#historial" data-page="historial"><i class="fas fa-history"></i> Historial</a></li>
            <li><a href="#contacto" data-page="contacto"><i class="fas fa-envelope"></i> Contacto</a></li>
            <li><a href="#" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="main-header">
            <h4 id="current-page-title">Mi Perfil</h4>
            </a>
        </div>
        
        <!-- Perfil Page -->
        <div id="perfil" class="page active">
            <div class="row">
                <div class="col-md-8">
                    <div class="profile-card">
    <h4 class="section-title">Información Personal</h4>
    <form id="perfilForm">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="perfilNombre" class="form-label">Nombre Completo</label>
                    <input type="text" class="form-control" id="perfilNombre" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="perfilEmail" class="form-label">Correo Electrónico</label>
                    <input type="email" class="form-control" id="perfilEmail" required>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="perfilTelefono" class="form-label">Teléfono</label>
                    <input type="tel" class="form-control" id="perfilTelefono" required>
                </div>
            </div>
        </div>
        
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
            <button type="button" class="btn btn-outline-secondary me-md-2" id="cancelEditProfile">Cancelar</button>
            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
    </form>
</div>
                    
                    <div class="profile-card">
                        <h4 class="section-title">Cambiar Contraseña</h4>
                        <form id="passwordForm">
                            <div class="mb-3">
                                <label for="perfilPasswordActual" class="form-label">Contraseña Actual</label>
                                <input type="password" class="form-control" id="perfilPasswordActual" required>
                            </div>
                            <div class="mb-3">
                                <label for="perfilPasswordNueva" class="form-label">Nueva Contraseña</label>
                                <input type="password" class="form-control" id="perfilPasswordNueva" required>
                            </div>
                            <div class="mb-3">
                                <label for="perfilPasswordConfirmar" class="form-label">Confirmar Nueva Contraseña</label>
                                <input type="password" class="form-control" id="perfilPasswordConfirmar" required>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="submit" class="btn btn-primary">Cambiar Contraseña</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="profile-card">
                        <h4 class="section-title">Preferencias</h4>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="notificacionesEmail" checked>
                            <label class="form-check-label" for="notificacionesEmail">Notificaciones por email</label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="notificacionesSMS" checked>
                            <label class="form-check-label" for="notificacionesSMS">Notificaciones por SMS</label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="recordatorios" checked>
                            <label class="form-check-label" for="recordatorios">Recordatorios de reservas</label>
                        </div>
                    </div>
                    
                    <div class="profile-card">
                        <h4 class="section-title">Zona Peligrosa</h4>
                        <p class="text-muted">Estas acciones no se pueden deshacer.</p>
                        <button class="btn btn-outline-danger w-100 mb-2">
                            <i class="fas fa-file-export"></i> Exportar mis datos
                        </button>
                        <button class="btn btn-outline-danger w-100">
                            <i class="fas fa-user-times"></i> Eliminar mi cuenta
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Canchas Page -->
        <div id="canchas" class="page">
            <div class="profile-card">
                <h4 class="section-title">Nuestras Canchas</h4>
                <p>Selecciona una cancha para realizar tu reserva.</p>
                
                <div class="row" id="canchasContainer">
                    <!-- Las canchas se cargarán dinámicamente aquí -->
                </div>
            </div>
        </div>
        
        <!-- Reservas Page -->
        <div id="reservas" class="page">
            <div class="profile-card">
                <h4 class="section-title">Nueva Reserva</h4>
                <form id="reservaForm" class="card p-4 shadow-sm">
                    <div class="mb-3">
                        <label for="cancha" class="form-label">Selecciona una Cancha</label>
                        <select class="form-select" id="cancha" required></select>
                    </div>
                    <div class="mb-3">
                        <label for="fecha" class="form-label">Fecha</label>
                        <input type="date" class="form-control" id="fecha" required>
                    </div>
                    <div class="mb-3">
                        <label for="hora" class="form-label">Horario Disponible</label>
                        <select class="form-select" id="hora" required></select>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Confirmar Reserva</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Mis Reservas Page -->
        <div id="mis-reservas" class="page">
            <div class="profile-card">
                <h4 class="section-title">Mis Reservas Activas</h4>
                
                <div class="search-reservas">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" placeholder="Buscar reservas..." id="searchReservas">
                        <button class="btn btn-outline-secondary" type="button" id="btnSearchReservas">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="showPastReservas" checked>
                        <label class="form-check-label" for="showPastReservas">Mostrar reservas pasadas</label>
                    </div>
                </div>
                
                <div class="row" id="misReservas">
                    <!-- Las reservas se cargarán dinámicamente aquí -->
                </div>
                
                <nav aria-label="Page navigation" class="mt-4" id="paginationContainer">
                    <ul class="pagination justify-content-center">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1">Anterior</a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#">Siguiente</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
        
        <!-- Historial Page -->
        <div id="historial" class="page">
            <div class="profile-card">
                <h4 class="section-title">Historial de Reservas</h4>
                <div class="table-responsive">
                    <table class="table" id="historialTable">
                        <thead>
                            <tr>
                                <th>Cancha</th>
                                <th>Fecha</th>
                                <th>Hora</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- El historial se cargará dinámicamente aquí -->
                        </tbody>
                    </table>
                </div>
                
                <nav aria-label="Page navigation" class="mt-4" id="historialPagination">
                    <ul class="pagination justify-content-center">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1">Anterior</a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#">Siguiente</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
        
        <!-- Contacto Page -->
        <div id="contacto" class="page">
            <div class="row">
                <div class="col-md-6">
                    <div class="profile-card">
                        <h4 class="section-title">Información de Contacto</h4>
                        <ul class="list-unstyled">
                            <li class="mb-3"><i class="fas fa-map-marker-alt me-2"></i> Av. Deportiva 1234, Ciudad Deportiva, CP 12345</li>
                            <li class="mb-3"><i class="fas fa-phone me-2"></i> +52 55 1234 5678</li>
                            <li class="mb-3"><i class="fas fa-envelope me-2"></i> info@reservacanchas.com</li>
                            <li class="mb-3"><i class="fab fa-whatsapp me-2"></i> +52 55 8765 4321 (WhatsApp)</li>
                        </ul>
                        <h5 class="mt-4">Horario de Atención</h5>
                        <ul class="list-unstyled">
                            <li><strong>Lunes a Viernes:</strong> 8:00 AM - 10:00 PM</li>
                            <li><strong>Sábados y Domingos:</strong> 7:00 AM - 11:00 PM</li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="profile-card">
                        <h4 class="section-title">Formulario de Contacto</h4>
                        <form id="contactoForm">
                            <div class="mb-3">
                                <label for="contactoNombre" class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="contactoNombre" required>
                            </div>
                            <div class="mb-3">
                                <label for="contactoEmail" class="form-label">Correo Electrónico</label>
                                <input type="email" class="form-control" id="contactoEmail" required>
                            </div>
                            <div class="mb-3">
                                <label for="contactoAsunto" class="form-label">Asunto</label>
                                <input type="text" class="form-control" id="contactoAsunto" required>
                            </div>
                            <div class="mb-3">
                                <label for="contactoMensaje" class="form-label">Mensaje</label>
                                <textarea class="form-control" id="contactoMensaje" rows="4" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Enviar Mensaje</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalles de reserva -->
    <div class="modal fade" id="reservaDetalleModal" tabindex="-1" aria-labelledby="reservaDetalleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content modal-detalles">
                <div class="modal-header">
                    <h5 class="modal-title" id="reservaDetalleModalLabel">Detalles de Reserva</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="reservaDetalleContent">
                    <!-- Contenido dinámico de los detalles de la reserva -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="btnModificarReserva">Modificar Reserva</button>
                    <button type="button" class="btn btn-danger" id="btnCancelarReserva">Cancelar Reserva</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:5000';

        // Función para cargar canchas desde la API
        async function cargarCanchas() {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/courts`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await res.json();
                if (!data.success) throw new Error("No se pudieron cargar las canchas");

                const container = document.getElementById('canchasContainer');
                container.innerHTML = '';

                data.courts.forEach(c => {
                    const card = document.createElement('div');
                    card.className = 'col-md-4 mb-4';
                    card.innerHTML = `
                        <div class="card h-100">
                            <img src="${c.image || 'https://via.placeholder.com/300x200'}" class="card-img-top" alt="${c.name}">
                            <div class="card-body">
                                <h5 class="card-title">${c.name}</h5>
                                <p class="card-text">${c.description || ''}</p>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-ruler"></i> Superficie: ${c.surface}</li>
                                    <li><i class="fas fa-users"></i> Capacidad: ${c.capacity} jugadores</li>
                                    <li><i class="fas fa-money-bill-wave"></i> Precio: $${c.price}/hr</li>
                                </ul>
                            </div>
                            <div class="card-footer bg-transparent">
                                <a href="#reservas" class="btn btn-primary w-100" data-page="reservas" data-court="${c.type}">Reservar</a>
                            </div>
                        </div>`;
                    container.appendChild(card);
                });

            } catch (err) {
                console.error("Error al cargar canchas:", err.message);
            }
        }

        // Función para cargar horarios disponibles
        async function cargarHorariosDisponibles(canchaId, fecha) {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/courts/${canchaId}/availability?date=${fecha}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await res.json();
                if (!data.success) throw new Error("No se pudieron cargar los horarios");

                const horaSelect = document.getElementById('hora');
                horaSelect.innerHTML = '<option value="" selected disabled>Seleccione una hora</option>';

                data.availableSlots.forEach(slot => {
                    const option = document.createElement('option');
                    option.value = slot.startTime;
                    option.textContent = `${slot.startTime} - ${slot.endTime}`;
                    horaSelect.appendChild(option);
                });

            } catch (err) {
                console.error("Error al cargar horarios:", err.message);
            }
        }

        // Función para cargar las reservas del usuario
        async function cargarReservas() {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/reservations`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await res.json();
                if (!data.success) throw new Error("No se pudieron cargar las reservas");

                const container = document.getElementById('misReservas');
                container.innerHTML = '';

                if (data.reservations.length === 0) {
                    container.innerHTML = '<div class="col-12 text-center py-5"><h5>No tienes reservas activas</h5><p>¡Haz una nueva reserva en la pestaña "Nueva Reserva"!</p></div>';
                    document.getElementById('paginationContainer').style.display = 'none';
                    return;
                }

                data.reservations.forEach(reserva => {
                    const estadoClass = `estado-${reserva.status.toLowerCase()}`;
                    const estadoText = reserva.status === 'confirmed' ? 'Confirmada' : 
                                      reserva.status === 'pending' ? 'Pendiente' : 
                                      reserva.status === 'cancelled' ? 'Cancelada' : reserva.status;

                    const cardHtml = `
                        <div class="col-md-6 mb-3">
                            <div class="card reserva-card h-100" data-reserva-id="${reserva.id}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <h5 class="card-title">${reserva.courtName}</h5>
                                        <span class="badge-estado ${estadoClass}">${estadoText}</span>
                                    </div>
                                    <h6 class="card-subtitle mb-2 text-muted">${new Date(reserva.date).toLocaleDateString('es-ES')}</h6>
                                    <p class="card-text">
                                        <i class="fas fa-clock"></i> ${reserva.startTime} - ${reserva.endTime}<br>
                                        <i class="fas fa-user-friends"></i> ${reserva.players} jugadores
                                    </p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-success fw-bold">$${reserva.price.toFixed(2)} MXN</span>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary me-1 btn-detalles-reserva">
                                                <i class="fas fa-info-circle"></i> Detalles
                                            </button>
                                            ${reserva.status !== 'cancelled' ? `
                                            <button class="btn btn-sm btn-outline-danger btn-cancelar-reserva">
                                                <i class="fas fa-times"></i> Cancelar
                                            </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.innerHTML += cardHtml;
                });

                // Agregar eventos a los botones
                document.querySelectorAll('.btn-detalles-reserva').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const reservaId = parseInt(this.closest('.card').getAttribute('data-reserva-id'));
                        mostrarDetallesReserva(reservaId);
                    });
                });

                document.querySelectorAll('.btn-cancelar-reserva').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const reservaId = parseInt(this.closest('.card').getAttribute('data-reserva-id'));
                        if (confirm('¿Estás seguro que deseas cancelar esta reserva?')) {
                            cancelarReserva(reservaId);
                        }
                    });
                });

            } catch (err) {
                console.error("Error al cargar reservas:", err.message);
            }
        }

        // Función para mostrar detalles de una reserva
        async function mostrarDetallesReserva(reservaId) {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/reservations/${reservaId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await res.json();
                if (!data.success) throw new Error("No se pudo cargar la reserva");

                const reserva = data.reservation;
                let estadoBadge = '';

                switch(reserva.status) {
                    case 'confirmed':
                        estadoBadge = '<span class="badge-estado estado-confirmada">Confirmada</span>';
                        break;
                    case 'pending':
                        estadoBadge = '<span class="badge-estado estado-pendiente">Pendiente</span>';
                        break;
                    case 'cancelled':
                        estadoBadge = '<span class="badge-estado estado-cancelada">Cancelada</span>';
                        break;
                    default:
                        estadoBadge = `<span class="badge-estado">${reserva.status}</span>`;
                }

                const modalContent = document.getElementById('reservaDetalleContent');
                modalContent.innerHTML = `
                    <div class="reserva-detalle">
                        <div class="reserva-detalle-header">
                            <h4>${reserva.courtName}</h4>
                            ${estadoBadge}
                        </div>
                        <div class="reserva-detalle-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Fecha:</strong> ${new Date(reserva.date).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                    <p><strong>Hora:</strong> ${reserva.startTime} - ${reserva.endTime}</p>
                                    <p><strong>Duración:</strong> ${reserva.duration} horas</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Jugadores:</strong> ${reserva.players}</p>
                                    <p><strong>Precio:</strong> $${reserva.price.toFixed(2)} MXN</p>
                                    <p><strong>Reservado el:</strong> ${new Date(reserva.createdAt).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                                </div>
                            </div>
                            ${reserva.comments ? `
                            <div class="mt-3">
                                <h5>Comentarios</h5>
                                <p>${reserva.comments}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                // Configurar botones del modal
                const btnCancelar = document.getElementById('btnCancelarReserva');
                btnCancelar.setAttribute('data-reserva-id', reserva.id);

                // Mostrar u ocultar botones según el estado
                if (reserva.status === 'cancelled') {
                    document.getElementById('btnModificarReserva').style.display = 'none';
                    btnCancelar.style.display = 'none';
                } else {
                    document.getElementById('btnModificarReserva').style.display = 'inline-block';
                    btnCancelar.style.display = 'inline-block';
                }

                // Mostrar el modal
                const reservaDetalleModal = new bootstrap.Modal(document.getElementById('reservaDetalleModal'));
                reservaDetalleModal.show();

            } catch (err) {
                console.error("Error al cargar detalles de reserva:", err.message);
            }
        }

        // Función para cancelar una reserva
        async function cancelarReserva(reservaId) {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/reservations/${reservaId}/cancel`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await res.json();
                if (!data.success) throw new Error("No se pudo cancelar la reserva");

                alert('Reserva cancelada correctamente');
                cargarReservas();

            } catch (err) {
                console.error("Error al cancelar reserva:", err.message);
                alert('Error al cancelar la reserva: ' + err.message);
            }
        }

        // Función para crear una nueva reserva
        async function crearReserva(reservaData) {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/reservations`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(reservaData)
                });

                const data = await res.json();
                if (!data.success) throw new Error(data.message || "No se pudo crear la reserva");

                alert('Reserva creada con éxito');
                return data.reservation;

            } catch (err) {
                console.error("Error al crear reserva:", err.message);
                alert('Error al crear reserva: ' + err.message);
                throw err;
            }
        }

        // Función para cargar el historial de reservas
        async function cargarHistorial() {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/reservations/history`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await res.json();
                if (!data.success) throw new Error("No se pudo cargar el historial");

                const historialTable = document.getElementById('historialTable').querySelector('tbody');
                historialTable.innerHTML = '';

                if (data.reservations.length === 0) {
                    historialTable.innerHTML = '<tr><td colspan="5" class="text-center py-4">No hay reservas en tu historial</td></tr>';
                    document.getElementById('historialPagination').style.display = 'none';
                    return;
                }

                data.reservations.forEach(reserva => {
                    let estadoBadge = '';
                    if (reserva.status === 'completed') {
                        estadoBadge = '<span class="badge bg-secondary">Completada</span>';
                    } else if (reserva.status === 'cancelled') {
                        estadoBadge = '<span class="badge bg-danger">Cancelada</span>';
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${reserva.courtName}</td>
                        <td>${new Date(reserva.date).toLocaleDateString('es-ES')}</td>
                        <td>${reserva.startTime} - ${reserva.endTime}</td>
                        <td>${estadoBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary btn-detalles-historial">
                                <i class="fas fa-info-circle"></i> Detalles
                            </button>
                        </td>
                    `;
                    row.setAttribute('data-reserva-id', reserva.id);
                    historialTable.appendChild(row);
                });

                // Agregar eventos a los botones de detalles
                document.querySelectorAll('.btn-detalles-historial').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const reservaId = parseInt(this.closest('tr').getAttribute('data-reserva-id'));
                        mostrarDetallesReserva(reservaId);
                    });
                });

            } catch (err) {
                console.error("Error al cargar historial:", err.message);
            }
        }

        // Función para actualizar el perfil del usuario
        async function actualizarPerfil(perfilData) {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/profile`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(perfilData)
                });

                const data = await res.json();
                if (!data.success) throw new Error(data.message || "No se pudo actualizar el perfil");

                alert('Perfil actualizado con éxito');
                return data.user;

            } catch (err) {
                console.error("Error al actualizar perfil:", err.message);
                alert('Error al actualizar perfil: ' + err.message);
                throw err;
            }
        }

        // Función para cambiar la contraseña
        async function cambiarContraseña(passwordData) {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/api/profile/password`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(passwordData)
                });

                const data = await res.json();
                if (!data.success) throw new Error(data.message || "No se pudo cambiar la contraseña");

                alert('Contraseña cambiada con éxito');
                return true;

            } catch (err) {
                console.error("Error al cambiar contraseña:", err.message);
                alert('Error al cambiar contraseña: ' + err.message);
                throw err;
            }
        }

        // Inicialización cuando el DOM está listo
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar modales de Bootstrap
            const reservaDetalleModal = new bootstrap.Modal(document.getElementById('reservaDetalleModal'));
            
            // Manejar navegación entre páginas
            const navLinks = document.querySelectorAll('[data-page]');
            const pages = document.querySelectorAll('.page');
            const pageTitle = document.getElementById('current-page-title');
            
            // Mapeo de títulos de página
            const pageTitles = {
                'perfil': 'Mi Perfil',
                'canchas': 'Canchas Disponibles',
                'reservas': 'Nueva Reserva',
                'mis-reservas': 'Mis Reservas Activas',
                'historial': 'Historial de Reservas',
                'contacto': 'Contacto'
            };
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Actualizar enlace de navegación activo
                    document.querySelectorAll('.sidebar-menu li a').forEach(navLink => {
                        navLink.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Mostrar página seleccionada
                    const pageId = this.getAttribute('data-page');
                    pages.forEach(page => {
                        page.classList.remove('active');
                        if (page.id === pageId) {
                            page.classList.add('active');
                            pageTitle.textContent = pageTitles[pageId] || 'ReservaCanchas';
                            
                            // Cargar datos específicos de la página si es necesario
                            if (pageId === 'canchas') {
                                cargarCanchas();
                            } else if (pageId === 'mis-reservas') {
                                cargarReservas();
                            } else if (pageId === 'historial') {
                                cargarHistorial();
                            } else if (pageId === 'reservas' && this.hasAttribute('data-court')) {
                                // Si viene de la página de canchas, preseleccionar la cancha
                                const courtType = this.getAttribute('data-court');
                                document.getElementById('cancha').value = courtType;
                            }
                        }
                    });
                    
                    // Desplazarse al inicio de la página
                    window.scrollTo(0, 0);
                });
            });
            
            // Configurar fecha mínima para reservas (hoy)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fecha').min = today;
            
            // Manejar envío de formularios
            document.getElementById('perfilForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                try {
                    const perfilData = {
                        name: document.getElementById('perfilNombre').value,
                        email: document.getElementById('perfilEmail').value,
                        phone: document.getElementById('perfilTelefono').value
                    };
                    
                    const usuario = await actualizarPerfil(perfilData);
                    
                    // Actualizar la foto y nombre en el sidebar
                    document.querySelector('.user-profile h5').textContent = usuario.name;
                    document.querySelector('.user-profile img').src = usuario.profileImage || '/frontend/assets/img/logo.png';
                    
                } catch (err) {
                    console.error(err);
                }
            });
            
            document.getElementById('passwordForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                try {
                    const passwordData = {
                        currentPassword: document.getElementById('perfilPasswordActual').value,
                        newPassword: document.getElementById('perfilPasswordNueva').value,
                        confirmPassword: document.getElementById('perfilPasswordConfirmar').value
                    };
                    
                    if (passwordData.newPassword !== passwordData.confirmPassword) {
                        alert('Las contraseñas no coinciden');
                        return;
                    }
                    
                    if (passwordData.newPassword.length < 6) {
                        alert('La contraseña debe tener al menos 6 caracteres');
                        return;
                    }
                    
                    await cambiarContraseña(passwordData);
                    this.reset();
                    
                } catch (err) {
                    console.error(err);
                }
            });
            
            document.getElementById('reservaForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                try {
                    const reservaData = {
                        courtId: document.getElementById('cancha').value,
                        date: document.getElementById('fecha').value,
                        startTime: document.getElementById('hora').value.split(' - ')[0],
                        players: 10 // Valor por defecto, podrías agregar un campo para esto
                    };
                    
                    await crearReserva(reservaData);
                    this.reset();
                    
                    // Redirigir a Mis Reservas
                    document.querySelector('[data-page="mis-reservas"]').click();
                    
                } catch (err) {
                    console.error(err);
                }
            });
            
            document.getElementById('contactoForm').addEventListener('submit', function(e) {
                e.preventDefault();
                alert('Mensaje enviado con éxito. Te responderemos pronto.');
                this.reset();
            });
            
           // Botón de cierre de sesión
            document.querySelectorAll('.logout-btn').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    if (confirm('¿Estás seguro que deseas cerrar sesión?')) {
                        try {
                            // Llamar a la función logout de auth.js
                            const { logout } = await import('/assets/js/auth.js');
                            logout();
                            // Redirigir a la página de login después de cerrar sesión
                            window.location.replace('/index.html');
                        } catch (error) {
                            console.error("Error al cerrar sesión:", error);
                            // Fallback básico si hay error cargando auth.js
                            localStorage.clear();
                            sessionStorage.clear();
                            window.location.replace('/auth/login.html?logout=' + Date.now());
                        }
                    }
                });
            });
            
            // Eventos para el formulario de reserva
            document.getElementById('cancha').addEventListener('change', function() {
                const fecha = document.getElementById('fecha').value;
                if (fecha) {
                    cargarHorariosDisponibles(this.value, fecha);
                }
            });
            
            document.getElementById('fecha').addEventListener('change', function() {
                const canchaId = document.getElementById('cancha').value;
                if (canchaId) {
                    cargarHorariosDisponibles(canchaId, this.value);
                }
            });
            
            // Cargar datos iniciales
            cargarCanchas();
        });
    </script>
</body>
</html>